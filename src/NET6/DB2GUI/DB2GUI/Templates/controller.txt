

#nullable enable
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
namespace Generated;

[Route("api/[controller]")]
[ApiController]
public partial class {{table.Name}}Controller : ControllerBase
{
    private ApplicationDbContext  _context ;
    public {{table.Name}}Controller(ApplicationDbContext context){
        _context=context;
    }

    [HttpGet]
    public IAsyncEnumerable<{{table.Name}}> GetAll(){
        return _context.{{table.Name}}.AsAsyncEnumerable();
    }
    {{ if numberKeys == 1  }}
    [HttpGet("{%{{}%}{{ firstKey.Name}}{%{}}%}")]
    public Task<{{table.Name}}> GetFromId({{firstKey.TypeName}} {{ firstKey.Name}}){
        return 
            _context.{{table.Name}}
                .Where(it=>it.{{ firstKey.Name}} == {{ firstKey.Name}})
                .FirstOrDefaultAsync();
    } 
    [HttpDelete("{%{{}%}{{ firstKey.Name}}{%{}}%}")]
    public async Task<bool> Delete({{firstKey.TypeName}} {{ firstKey.Name}}){
        var item=await 
            _context.{{table.Name}}
                .Where(it=>it.{{ firstKey.Name}} == {{ firstKey.Name}})
                .FirstOrDefaultAsync();
        if(item == null)
            return false;

        _context.{{table.Name}}.Remove(item);
        await _context.SaveChangesAsync();
        return true; 
    } 
    [HttpPut]
    public async Task<bool> Put({{table.Name}} val){        
        var item=await 
            _context.{{table.Name}}
                .Where(it=>it.{{ firstKey.Name}} == val.{{ firstKey.Name}})
                .FirstOrDefaultAsync();
        if(item == null)
            return false;

        item.CopyFrom(val);        
        await _context.SaveChangesAsync();
        return true;
    }

    {{else}}
    //generate just for keys 1, not for {{numberKeys}}
    {{ end }}
     
    [HttpPost]
    public async Task<{{table.Name}}> Post({{table.Name}} val){
        _context.{{table.Name}}.Add(val);
        await _context.SaveChangesAsync();
        return val;
    }
    
}

[Route("api/[controller]/[action]")]
[ApiController]

public partial class {{table.Name}}MetadataController : ControllerBase
{
    [HttpGet]
    public string Name(){
        return "{{table.Name}}";
    }
    [HttpGet]
    public KeyValuePair<int,string>[] Columns(){
        return Enum.GetValues<e{{table.Name}}Columns>()
          .Select(it=>new KeyValuePair<int,string>((int)it,it.ToString()))
                .ToArray();        
        ;
    }
    [HttpGet]
    public KeyValuePair<int,string>[] SearchCriteria(){
        return Enum.GetValues<SearchCriteria>()
          .Select(it=>new KeyValuePair<int,string>((int)it,it.ToString()))
                .ToArray();        
        ;
    }
    

}

[Route("api/[controller]/[action]")]
[ApiController]

public partial class {{table.Name}}XController : ControllerBase
{
    private ApplicationDbContext  _context ;
    public {{table.Name}}XController(ApplicationDbContext context){
        _context=context;
    }
    
    [HttpPost]
    public IAsyncEnumerable<{{table.Name}}> Search(SearchField<e{{table.Name}}Columns> search){
            return _context.{{table.Name}}SimpleSearch(search);
        }

    {{ for col in cols}}
    [HttpGet("{%{{}%}Criteria{%{}}%}/{%{{}%}value{%{}}%}")]
    public IAsyncEnumerable<{{table.Name}}> Search_{{col.Name}}(SearchCriteria Criteria , {{col.TypeName}} value){
            System.Diagnostics.Debugger.Break();
            var search =new SearchField<e{{table.Name}}Columns>();
            search.FieldName = e{{table.Name}}Columns.{{col.Name}};
            search.Value=value.ToString();
            search.Criteria=Criteria;
            return this.Search(search);
        }
    {{ end }}
    [HttpPost]
    public IAsyncEnumerable<{{table.Name}}> AdvancedSearch(Search{{table.Name}} search){
            return _context.{{table.Name}}Find_AsyncEnumerable(search);
        }
    [HttpPost]
    public Task<long> Count(Search{{table.Name}} search){
            return _context.{{table.Name}}Count(search);
        }
}
    
#nullable restore